#!/bin/bash
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# LedSaber Dashboard Launcher
# BTTop-style Live Monitor - Resistance Edition
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/venv"
PYTHON_SCRIPT="$SCRIPT_DIR/saber_dashboard.py"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš”ï¸  LEDSABER DASHBOARD - RESISTANCE EDITION"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. Controlla Virtual Environment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if [ ! -d "$VENV_DIR" ]; then
    echo "ğŸ”§ Virtual environment non trovato. Creazione in corso..."
    python3 -m venv "$VENV_DIR"
    echo "âœ“ Virtual environment creato"
fi

echo "ğŸ Attivazione virtual environment..."
source "$VENV_DIR/bin/activate"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2. Verifica dipendenze
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ“¦ Verifica dipendenze..."

# Controlla se textual Ã¨ installato
if ! python -c "import textual" 2>/dev/null; then
    echo "âš ï¸  Textual non trovato. Installazione dipendenze..."
    pip install -q textual rich bleak
    echo "âœ“ Dipendenze installate"
else
    echo "âœ“ Dipendenze OK"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3. Verifica permessi Bluetooth
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ“¡ Verifica permessi Bluetooth..."

if ! groups | grep -q bluetooth; then
    echo "âš ï¸  ATTENZIONE: L'utente non Ã¨ nel gruppo 'bluetooth'"
    echo "   Per risolvere, esegui:"
    echo "   sudo usermod -a -G bluetooth $USER"
    echo "   Poi riavvia la sessione (logout/login)"
    echo ""
    echo "   Provo comunque ad avviare..."
else
    echo "âœ“ Permessi Bluetooth OK"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4. Controlla dimensioni terminale
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TERM_COLS=$(tput cols)
TERM_LINES=$(tput lines)

echo "ğŸ“ Dimensioni terminale: ${TERM_COLS}x${TERM_LINES}"

if [ "$TERM_COLS" -lt 80 ] || [ "$TERM_LINES" -lt 24 ]; then
    echo "âš ï¸  ATTENZIONE: Terminale troppo piccolo!"
    echo "   Dimensioni minime raccomandate: 80x24"
    echo "   Dimensioni ottimali: 100x30 o superiori"
    echo ""
    echo "   Ridimensiona il terminale per una migliore esperienza."
    echo ""
    read -p "   Vuoi continuare comunque? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Uscita."
        exit 1
    fi
else
    echo "âœ“ Dimensioni terminale OK"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5. Avvio Dashboard
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Avvio Dashboard..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ Quick Start:"
echo "   â€¢ Premi Ctrl+S per scansionare e connettere"
echo "   â€¢ Premi F2 per inizializzare camera"
echo "   â€¢ Premi F3 per avviare camera"
echo "   â€¢ Premi F5 per toggle motion detection"
echo "   â€¢ Digita 'help' per lista comandi completa"
echo ""
echo "   Ctrl+C per uscire"
echo ""
sleep 2

# Avvia dashboard
python "$PYTHON_SCRIPT"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6. Cleanup
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
echo "ğŸ‘‹ Dashboard chiusa."
echo ""
